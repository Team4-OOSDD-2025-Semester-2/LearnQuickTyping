name: Unit Tests
 
on:
  push:
    branches:
      - main
      - infra/runner-toevoegen
  pull_request:
    branches:
      - main
      - develop
 
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Haal de repository op
        uses: actions/checkout@v4
 
      - name: Installeer .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'
 
      - name: Installeer MAUI workloads
        run: dotnet workload install maui-android
 
      - name: Herstel afhankelijkheden
        run: dotnet restore LearnQuickTyping/LearnQuickTyping.sln
 
      - name: Bouw de applicatie
        run: dotnet build LearnQuickTyping/LearnQuickTyping.sln --configuration Release --no-restore
 
      - name: Voer geautomatiseerde tests uit
        run: |
          dotnet test LearnQuickTyping/LearnQuickTyping.TestCore/LearnQuickTyping.TestCore.csproj \
            --configuration Release \
            --no-restore --no-build \
            --logger "trx;LogFileName=TestResults.trx" \
            --logger "console;verbosity=detailed" \
            --results-directory "LearnQuickTyping/TestResults"
        continue-on-error: true
 
      - name: Genereer test log
        run: |
          mkdir -p LearnQuickTyping/TestResults
          echo "=== GEAUTOMATISEERDE TEST RAPPORT ===" > LearnQuickTyping/TestResults/test-log.txt
          echo "Datum: $(date)" >> LearnQuickTyping/TestResults/test-log.txt
          echo "Pipeline run: ${{ github.run_number }}" >> LearnQuickTyping/TestResults/test-log.txt
          echo "Branch: ${{ github.ref_name }}" >> LearnQuickTyping/TestResults/test-log.txt
          echo "Commit: ${{ github.sha }}" >> LearnQuickTyping/TestResults/test-log.txt
          echo "" >> LearnQuickTyping/TestResults/test-log.txt
          
          if [ -f "LearnQuickTyping/TestResults/TestResults.trx" ]; then
            echo "TEST RESULTATEN:" >> LearnQuickTyping/TestResults/test-log.txt
            TOTAL=$(grep -o 'total="[0-9]*"' LearnQuickTyping/TestResults/TestResults.trx | grep -o '[0-9]*' || echo "0")
            PASSED=$(grep -o 'passed="[0-9]*"' LearnQuickTyping/TestResults/TestResults.trx | grep -o '[0-9]*' || echo "0")
            FAILED=$(grep -o 'failed="[0-9]*"' LearnQuickTyping/TestResults/TestResults.trx | grep -o '[0-9]*' || echo "0")
            
            echo "- Totaal: $TOTAL tests" >> LearnQuickTyping/TestResults/test-log.txt
            echo "- Geslaagd: $PASSED tests" >> LearnQuickTyping/TestResults/test-log.txt
            echo "- Gefaald: $FAILED tests" >> LearnQuickTyping/TestResults/test-log.txt
            
            if [ "$FAILED" = "0" ]; then
              echo "- Status: ALLE TESTS GESLAAGD" >> LearnQuickTyping/TestResults/test-log.txt
            else
              echo "- Status: $FAILED TESTS GEFAALD" >> LearnQuickTyping/TestResults/test-log.txt
            fi
          else
            echo "FOUT: Geen test resultaten gevonden!" >> LearnQuickTyping/TestResults/test-log.txt
          fi
          
          echo "" >> LearnQuickTyping/TestResults/test-log.txt
          echo "=== INSTRUCTIES ===" >> LearnQuickTyping/TestResults/test-log.txt
          echo "1. Download dit artefact" >> LearnQuickTyping/TestResults/test-log.txt
          echo "2. Open TestResults.trx in Visual Studio voor details" >> LearnQuickTyping/TestResults/test-log.txt
          echo "3. Bekijk test-log.txt voor samenvatting" >> LearnQuickTyping/TestResults/test-log.txt
        if: always()
 
      - name: Upload test resultaten
        uses: actions/upload-artifact@v4
        with:
          name: test-resultaten
          path: |
            LearnQuickTyping/TestResults/TestResults.trx
            LearnQuickTyping/TestResults/test-log.txt
        if: always()
